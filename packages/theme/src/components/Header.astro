---
import type { Locale } from '../i18n';
import { getTranslations } from '../i18n';

interface Props {
  siteTitle?: string;
  currentPath?: string;
  locale?: Locale;
}

const {
  siteTitle = "My Space.",
  currentPath = "/",
  locale = 'zh'
} = Astro.props;

const t = getTranslations(locale);

// Add lang parameter to href if locale is not default (zh)
const addLangParam = (href: string) => {
  if (locale !== 'zh') {
    const separator = href.includes('?') ? '&' : '?';
    return `${href}${separator}lang=${locale}`;
  }
  return href;
};

const navItems = [
  { href: addLangParam("/"), label: t.nav.home },
  { href: addLangParam("/archive"), label: t.nav.articles },
  { href: addLangParam("/about"), label: t.nav.about },
];

const isActive = (href: string) => {
  // Extract pathname from href (remove query parameters)
  const hrefPath = href.split('?')[0].split('#')[0];
  const normalizedPath = currentPath.endsWith('/') ? currentPath.slice(0, -1) : currentPath;
  const normalizedHref = hrefPath.endsWith('/') ? hrefPath.slice(0, -1) : hrefPath;

  if (normalizedHref === '') {
    return normalizedPath === '';
  }
  return normalizedPath.startsWith(normalizedHref);
};
---

<header class="md-header">
  <div class="header-controls">
    <button
      class="icon-btn"
      id="locale-toggle"
      aria-label="Switch language"
      title={t.language.switchTo}
    >
      <svg class="icon" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/>
      </svg>
      <span class="sr-only locale-label">{t.language.switchTo}</span>
      <div class="ripple-container"></div>
    </button>

    <button
      class="icon-btn theme-toggle"
      id="theme-toggle"
      aria-label={t.theme.toggle}
      title={t.theme.toggle}
    >
      <svg class="icon icon-sun" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
      </svg>
      <svg class="icon icon-moon" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
      </svg>
      <span id="theme-toggle-text" class="sr-only">{t.theme.darkMode}</span>
      <div class="ripple-container"></div>
    </button>
  </div>

  <h1 class="blog-title">{siteTitle}</h1>
  <nav class="nav-tabs">
    {navItems.map((item) => (
      <a
        href={item.href}
        class={`nav-link ${isActive(item.href) ? 'active' : ''}`}
      >
        {item.label}
        <span class="nav-ripple"></span>
      </a>
    ))}
  </nav>
</header>

<script is:inline define:vars={{ locale }}>
  const translations = {
    zh: {
      switchTo: 'English',
      darkMode: '深色模式',
      lightMode: '浅色模式'
    },
    en: {
      switchTo: '中文',
      darkMode: 'Dark Mode',
      lightMode: 'Light Mode'
    }
  };

  function updateLocaleButton() {
    const currentLocale = localStorage.getItem('locale') || 'zh';
    const button = document.getElementById('locale-toggle');
    if (button) {
      const label = button.querySelector('.locale-label');
      if (label) {
        label.textContent = translations[currentLocale].switchTo;
      }
      button.setAttribute('title', translations[currentLocale].switchTo);
    }
  }

  function switchLocale() {
    // Determine current locale from URL or fallback to props
    const urlParams = new URLSearchParams(window.location.search);
    const currentLocale = urlParams.get('lang') || locale;
    const newLocale = currentLocale === 'zh' ? 'en' : 'zh';
    
    // Save preference
    localStorage.setItem('locale', newLocale);

    // Update URL parameter and navigate
    const url = new URL(window.location.href);
    url.searchParams.set('lang', newLocale);

    // Use direct assignment to trigger full page reload
    window.location.href = url.toString();
  }

  function updateThemeButton() {
    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    const text = document.getElementById('theme-toggle-text');
    const button = document.getElementById('theme-toggle');
    if (text && button) {
      const currentLocale = localStorage.getItem('locale') || locale;
      const label = theme === 'dark'
        ? translations[currentLocale].lightMode
        : translations[currentLocale].darkMode;
      text.textContent = label;
      button.setAttribute('title', label);
      button.setAttribute('aria-label', label);
    }
  }

  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    if (document.startViewTransition) {
      document.startViewTransition(() => {
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeButton();
      });
    } else {
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeButton();
    }
  }

  function createRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement('span');
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;

    const rect = button.getBoundingClientRect();
    
    circle.style.width = circle.style.height = `${diameter}px`;
    circle.style.left = `${event.clientX - rect.left - radius}px`;
    circle.style.top = `${event.clientY - rect.top - radius}px`;
    circle.classList.add('ripple');

    const rippleContainer = button.querySelector('.ripple-container') || button;
    
    // Remove existing ripples
    const existingRipples = rippleContainer.getElementsByClassName('ripple');
    if (existingRipples.length > 0) {
      existingRipples[0].remove();
    }

    rippleContainer.appendChild(circle);

    // Remove ripple after animation
    setTimeout(() => {
      circle.remove();
    }, 600);
  }

  function updateNavLinks() {
    // Get current lang parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentLang = urlParams.get('lang');
    
    // Update links if lang parameter exists (preserve lang when navigating)
    if (currentLang && (currentLang === 'zh' || currentLang === 'en')) {
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach((link) => {
        const href = link.getAttribute('href');
        if (href) {
          try {
            const url = new URL(href, window.location.origin);
            // Update lang parameter to match current page
            url.searchParams.set('lang', currentLang);
            link.setAttribute('href', url.pathname + url.search);
          } catch (e) {
            // If URL parsing fails, try simple string manipulation
            const hasQuery = href.includes('?');
            const hasLang = href.includes('lang=');
            
            if (hasLang) {
              // Replace existing lang parameter
              const newHref = href.replace(/[?&]lang=[^&]*/, '');
              const separator = newHref.includes('?') ? '&' : '?';
              link.setAttribute('href', `${newHref}${separator}lang=${currentLang}`);
            } else {
              // Add lang parameter
              const separator = hasQuery ? '&' : '?';
              link.setAttribute('href', `${href}${separator}lang=${currentLang}`);
            }
          }
        }
      });
    } else {
      // If no lang parameter, remove it from links (default to zh)
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach((link) => {
        const href = link.getAttribute('href');
        if (href && href.includes('lang=')) {
          try {
            const url = new URL(href, window.location.origin);
            url.searchParams.delete('lang');
            const newHref = url.pathname + (url.search ? url.search : '');
            link.setAttribute('href', newHref || url.pathname);
          } catch (e) {
            // If URL parsing fails, try simple string manipulation
            link.setAttribute('href', href.replace(/[?&]lang=[^&]*/, '').replace(/\?$/, ''));
          }
        }
      });
    }
  }

  function initHeader() {
    const toggleBtn = document.getElementById('theme-toggle');
    const localeBtn = document.getElementById('locale-toggle');
    
    // Prevent multiple initializations
    if (toggleBtn?.dataset.initialized) return;

    // Initialize locale
    const urlParams = new URLSearchParams(window.location.search);
    const urlLocale = urlParams.get('lang');

    if (urlLocale && (urlLocale === 'zh' || urlLocale === 'en')) {
      localStorage.setItem('locale', urlLocale);
    } else if (!localStorage.getItem('locale')) {
      localStorage.setItem('locale', locale);
    }

    updateLocaleButton();
    
    // Update navigation links to preserve lang parameter
    updateNavLinks();

    // Apply and initialize theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeButton();

    // Attach event listeners
    if (toggleBtn) {
      toggleBtn.dataset.initialized = 'true';
      toggleBtn.addEventListener('click', (e) => {
        createRipple(e);
        toggleTheme();
      });
    }

    if (localeBtn) {
      localeBtn.dataset.initialized = 'true';
      localeBtn.addEventListener('click', (e) => {
        createRipple(e);
        switchLocale();
      });
    }
  }

  // Initialize on page load
  initHeader();

  // Re-initialize after view transitions (for Astro)
  document.addEventListener('astro:page-load', initHeader);
</script>

<style>
  .md-header {
    background-color: var(--header-bg);
    color: var(--header-text);
    padding: 40px 20px 0 20px;
    padding-bottom: 0;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    position: relative;
    z-index: 1;
    box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1);
  }

  .header-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  /* Material Icon Button Styles */
  .icon-btn {
    background: transparent;
    border: none;
    color: var(--header-text);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    outline: none;
    -webkit-tap-highlight-color: transparent;
  }

  .icon-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .icon-btn:active {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  /* Focus styles for accessibility */
  .icon-btn:focus-visible {
    background-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
  }

  .icon {
    pointer-events: none; /* Let clicks pass to button */
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Theme Toggle Logic */
  .theme-toggle .icon-sun {
    display: none;
  }
  .theme-toggle .icon-moon {
    display: block;
  }

  /* Use global selector for theme state */
  :global(html[data-theme='dark']) .theme-toggle .icon-sun {
    display: block;
  }
  :global(html[data-theme='dark']) .theme-toggle .icon-moon {
    display: none;
  }

  /* Ripple Effect */
  .ripple-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 50%;
    pointer-events: none;
  }

  :global(span.ripple) {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 0.6s linear;
    background-color: rgba(255, 255, 255, 0.3);
  }

  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  .blog-title {
    font-family: var(--font-serif);
    font-size: 2.5rem;
    font-weight: normal;
    margin: 20px 0 0 12px;
    letter-spacing: -1px;
  }

  .nav-tabs {
    display: flex;
    margin-top: 30px;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .nav-link {
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    text-transform: uppercase;
    font-weight: 500;
    font-size: 0.875rem; /* 14px */
    padding: 12px 24px;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s, background-color 0.2s;
    position: relative;
    letter-spacing: 0.5px;
  }

  .nav-link.active {
    color: #fff;
    border-bottom-color: var(--accent);
  }

  .nav-link:hover {
    color: #fff;
    background-color: rgba(255, 255, 255, 0.05);
  }

  @media (max-width: 700px) {
    .md-header {
      padding-top: 20px;
    }

    .header-controls {
      right: 8px;
      gap: 4px;
    }

    .blog-title {
      font-size: 2rem;
      margin-left: 8px;
    }
    
    .nav-link {
       padding: 8px 16px;
       font-size: 0.8rem;
    }
  }
</style>
