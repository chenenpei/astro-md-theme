---
import HomePage from '@chenenpei/astro-md-theme/templates/HomePage.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { SITE } from '../config';
import type { Locale } from '@chenenpei/astro-md-theme/i18n';

// Use Astro.url.searchParams directly to get dynamic behavior
const searchParams = Astro.url.searchParams;
const urlLocale = searchParams.get('lang') as Locale | null;

const locale: Locale = (urlLocale === 'zh' || urlLocale === 'en') ? urlLocale : 'zh'

const blogPosts = await getCollection('blog');
const posts = blogPosts
  .filter((post: CollectionEntry<'blog'>) => post.data.langs.includes(locale))
  .sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => 
    b.data.pubDate.getTime() - a.data.pubDate.getTime()
  )
  .slice(0, 5) // Show latest 5 posts on homepage
  .map((post: CollectionEntry<'blog'>) => ({
    title: post.data.title,
    slug: post.slug,
    excerpt: post.data.excerpt || post.data.description,
    date: post.data.pubDate,
    category: post.data.category,
    coverImage: post.data.coverImage || post.data.heroImage,
  }));
---

<HomePage
  siteTitle={SITE.title}
  siteDescription={SITE.description}
  authorName={SITE.author?.name}
  authorBio={SITE.author?.bio}
  authorAvatar={SITE.author?.avatar}
  socials={SITE.socials}
  posts={posts}
/>

